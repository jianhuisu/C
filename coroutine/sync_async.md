## 同步与异步

##### 异步的优势

高并发，同步阻塞IO模型的并发能力依赖于进程/线程数量，例如 php-fpm开启了200个进程，理论上最大支持的并发能力为200。如果每个请求平均需要100ms，
那么应用程序就可以提供 `(1*1000/100) * 200 = 2000qps`。异步非阻塞的并发能力几乎是无限的，可以发起或维持大量并发TCP连接
`无IO等待`，同步模型无法解决`IOWait`很高的场景，如上述例子每个请求平均要10s，那么应用程序就只能提供20qps了。而异步程序不存在IO等待，所以无论请求要花费多长时间，对整个程序的处理能力没有任何影响

##### 同步的优势

编码简单，同步模式编写/调试程序更轻松
可控性好，同步模式的程序具有良好的过载保护机制，如在下面的情况异步程序就会出问题
Accept保护，同步模式下一个TCP服务器最大能接受 进程数+Backlog 个TCP连接。一旦超过此数量，Server将无法再接受连接，客户端会连接失败。避免服务器Accept太多连接，导致请求堆积

什么是同步 IO：
简单的例子就是执行到 MySQL->query 的时候，这个进程什么事情都不做，等待 MySQL 返回结果，返回结果后再向下执行代码，所以同步 IO 的服务并发能力是很差的。

##### swoole编程风格 

swoole快速启动中的例子大部分都是异步风格的编程模式，用协程风格(就是用协程同样可以实现相同的功能)。
**协程使得原有的异步逻辑同步化**，但是在协程的切换是隐式发生的，所以在协程切换的前后不能保证全局变量以及`static`变量的一致性。

    快速启动
        TCP服务器
        UDP服务器
        HTTP服务器
        WebSocket服务器
        MQTT(物联网)服务器
        执行异步任务(Task)
        协程初探
        
原文地址https://wiki.swoole.com/#/start/start_server

 - 异步非阻塞模式，
 - 同步阻塞模式

##### TCP 粘包问题

应用通讯协议数据包,例如HTTP报文,SMTP报文...
TCP包
IP包

###### 粘包产生原因

TCP协议是流式的，数据包没有边界。应用程序使用 TCP 通信就会面临难以分割流的问题。

发送时粘包:由于TCP协议本身的机制（面向连接的可靠地协议-三次握手机制）客户端与服务器会维持一个连接（Channel），
数据在连接不断开的情况下，可以持续不断地将多个数据包发往服务器，
但是如果发送的网络数据包太小，那么TCP本身会启用Nagle算法（可配置是否启用）对较小的数据包进行合并 然后等待包大小足够时再发送。
但是如果这样的话，服务器在接收到消息（数据流）的时候就无法从大包中分割出客户端发送的小包，这样产生了粘包.

接收时粘包:服务器在接收到数据库后，放到缓冲区中，如果消息没有被及时从缓存区取走，下次在取数据的时候可能就会出现一次取出多个小数据包的情况，也会产生粘包现象.

再说UDP：本身作为无连接的不可靠的传输协议（适合频繁发送较小的数据包），他不会对数据包进行合并发送（也就没有Nagle算法之说了），
他直接是一端发送什么数据，直接就发出去了，既然他不会对数据合并，每一个数据包都是完整的（数据+UDP头+IP头等等发一次数据封装一次）也就没有粘包一说了。

日常工作中经常遇到的 tcp 场景可能是 短连接单个消息 的模式，客户端发送一条消息后便关闭连接，服务端循环读取到EOF即可得到一条完整的消息。
但如果是 短连接多个消息 或 长链接模式 下，就可能会发生粘包，客户端不关闭服务端无法通过EOL确定消息读取完毕的问题。这就需要定义协议和拆包。

###### 分包

分包产生的原因就简单的多：可能是IP分片传输导致的，也可能是传输过程中丢失部分包导致出现的半包，还有可能就是一个包可能被分成了两次传输，在取数据的时候，先取到了一部分（还可能与接收的缓冲区大小有关系），总之就是一个数据包被分成了多次接收。

###### 解决方案

swoole在没有并发的情况下快速启动中的代码可以正常运行，但是并发高了就会有粘包问题.
因为 TCP 通信是流式的，在接收1个大数据包时，可能会被拆分成多个数据包发送。而多次Send小包时,底层也可能会合并成一次进行发送。这里就需要 2 个操作来解决：

分包：Server 收到了多个数据包，需要拆分数据包
合包：Server 收到的数据只是包的一部分，需要缓存数据，合并成完整的包

所以在TCP上层进行网络通信时需要设定通信协议。常见的TCP通用网络通信协议有 HTTP、HTTPS、FTP、SMTP、POP3、IMAP、SSH、Redis、Memcache、MySQL 。
例如HTTP采用固定 